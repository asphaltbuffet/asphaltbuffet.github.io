<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Monitoring my HVAC | asphaltbuffet dev blog</title><meta name=keywords content="arduino,go,grafana,timescale,async,monitoring,sensors"><meta name=description content="When I want to know how well my HVAC system is working, smart thermostats and ad-hoc checks don&rsquo;t get me as far as I&rsquo;d like. That means it&rsquo;s time to create an entire system to monitor that information and present it graphically. This is normal, right?
Requirements Overall, I didn&rsquo;t want to spend much money on this. Yes, time is money, blah blah blah. Learning new tech offsets the cost of time, and it&rsquo;s a better use of late-night chill time than playing a game anyway."><meta name=author content="Ben"><link rel=canonical href=https://asphaltbuffet.com/posts/2022/11/hvac-monitoring/><link crossorigin=anonymous href=/assets/css/stylesheet.106bd38c7fdf8e1964d2f143994e4e9c8e11f6465ecc860c4332edb4392869cf.css integrity="sha256-EGvTjH/fjhlk0vFDmU5OnI4R9kZezIYMQzLttDkoac8=" rel="preload stylesheet" as=style><link rel=icon href=https://asphaltbuffet.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://asphaltbuffet.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://asphaltbuffet.com/favicon-32x32.png><link rel=apple-touch-icon href=https://asphaltbuffet.com/apple-touch-icon.png><link rel=mask-icon href=https://asphaltbuffet.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-XTW4M04NS6"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XTW4M04NS6",{anonymize_ip:!1})}</script><meta property="og:title" content="Monitoring my HVAC"><meta property="og:description" content="When I want to know how well my HVAC system is working, smart thermostats and ad-hoc checks don&rsquo;t get me as far as I&rsquo;d like. That means it&rsquo;s time to create an entire system to monitor that information and present it graphically. This is normal, right?
Requirements Overall, I didn&rsquo;t want to spend much money on this. Yes, time is money, blah blah blah. Learning new tech offsets the cost of time, and it&rsquo;s a better use of late-night chill time than playing a game anyway."><meta property="og:type" content="article"><meta property="og:url" content="https://asphaltbuffet.com/posts/2022/11/hvac-monitoring/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-27T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-28T01:44:22-05:00"><meta property="og:site_name" content="asphaltbuffet dev blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Monitoring my HVAC"><meta name=twitter:description content="When I want to know how well my HVAC system is working, smart thermostats and ad-hoc checks don&rsquo;t get me as far as I&rsquo;d like. That means it&rsquo;s time to create an entire system to monitor that information and present it graphically. This is normal, right?
Requirements Overall, I didn&rsquo;t want to spend much money on this. Yes, time is money, blah blah blah. Learning new tech offsets the cost of time, and it&rsquo;s a better use of late-night chill time than playing a game anyway."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://asphaltbuffet.com/posts/"},{"@type":"ListItem","position":2,"name":"Monitoring my HVAC","item":"https://asphaltbuffet.com/posts/2022/11/hvac-monitoring/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Monitoring my HVAC","name":"Monitoring my HVAC","description":"When I want to know how well my HVAC system is working, smart thermostats and ad-hoc checks don\u0026rsquo;t get me as far as I\u0026rsquo;d like. That means it\u0026rsquo;s time to create an entire system to monitor that information and present it graphically. This is normal, right?\nRequirements Overall, I didn\u0026rsquo;t want to spend much money on this. Yes, time is money, blah blah blah. Learning new tech offsets the cost of time, and it\u0026rsquo;s a better use of late-night chill time than playing a game anyway.","keywords":["arduino","go","grafana","timescale","async","monitoring","sensors"],"articleBody":"When I want to know how well my HVAC system is working, smart thermostats and ad-hoc checks don’t get me as far as I’d like. That means it’s time to create an entire system to monitor that information and present it graphically. This is normal, right?\nRequirements Overall, I didn’t want to spend much money on this. Yes, time is money, blah blah blah. Learning new tech offsets the cost of time, and it’s a better use of late-night chill time than playing a game anyway. Plus, spoilers… there are graphs. That broad overview gave me the following criteria:\nDon’t buy much extra stuff. Keep it less than $20 spending. Easy to set up and keep running. The initial scale is one sensor. Don’t optimize until later, if ever. Choices, Choices, Choices Selecting the brains I have a box of microcontrollers in my project area. First, I was going to use a BeagleBoard that I got ~10 years ago at the Embedded Linux Conference. However, I could not find a power adapter for it, so after 20 minutes of searching, I nixed that idea.\nI considered using a raspberry pi, but even though I have a couple spares, I didn’t want that level of overkill to get a couple temp readings sent to the cloud.\nOh, but the handful of Arduino Ethernet boards that have PoE? Yes, please. It takes care of my need to plug into power (sort of, we’ll cover this later). 32k of memory should be fine (yeah, we’ll touch on this later too). The temp probes that I have will work fine with this and require minimal breadboard work.\nSelecting the sensors This took no time. I needed something I could insert into holes in our ductwork that our HVAC guy cut several months ago. I wanted to use these since it meant that it would get readings from the same place they do for efficiency checks, and I could do less permanent damage to our HVAC system.\nI also had two DS18B20 sensors laying around from a forgotten project. They are waterproof with long enough cords to work well around the furnace. As a bonus, they use a digital signal so I could use a couple of them on the same input on the arduino without worrying about collisions. This would be really handy later.\nSelecting the backend tooling I wanted to use MQTT for sensor communication so that I wasn’t creating my own protocol. There are a lot of alternatives that I never even considered using. Why? I know people who use MQTT at work. The availability of resources to sanity-check my work meets my goals for #2 really well.\nDatabase and visualization were chosen via similar criteria. I’ve used Grafana a lot recently to create dashboards, and there’s a free cloud version that gets me through proof-of-concept. Same deal with Timescale. The additional benefit of these technologies is that I can spin up instances at home for free later if I want to keep this party going. Or, I can decide to pay for the fully-managed versions in the cloud. This is a problem for future me and I’m good for now with what I have.\nSensor Development Wiring the Parts Together The sensor hardware itself was planned to be as plug-and-play as possible. I added an LED later to see flashy lights. It adds very little value since I am not spending much time in the room where this lives. The LED functionality isn’t even in the code I walk through below as it’s there as a debug tool more than anything, but I may update that source code later if I decide to leave it in.\nSensor Programming I started with the sensor ready and no real design. Was this a mistake? Yes. Would I do it the same next time? Also, yes.\nHonestly, the project software is fairly simple so skipping the design meant that now I need to redo a few things to get my data structured better and clean up a few edge cases for failures. It works as is, but it’s not pretty. Warts will be highlighted as we go. Grab the popcorn and follow along on the journey!\nInitially, I had planned to set up TinyGo and program the boards that way. I have not used TinyGo before. As of this post, I still have not used TinyGo. Arduino provides a web editor for creating sketches and installing them on boards with a minimal tool download. This was easy. See #2 criteria for information on why I went this route.\nI tackled the sensor programming in the following order:\nGet temp readings working Get the network connection working Get MQTT communication working Send temp readings via MQTT Reading in temps Fortunately, there’s already an arduino library for the sensors I used. I only needed to include OneWire.h and DallasTemperature.h for the software to function. I found a reference on wiring up multiple sensors that worked right away. In an hour or so, I had the following:\n// OneWire - Version: Latest #include // DallasTemperature - Version: Latest #include #include #include // hardware config #define ONE_WIRE_BUS 2 OneWire oneWire(ONE_WIRE_BUS); DallasTemperature sensors(\u0026oneWire); // take reading every 60s const long interval = 6000; unsigned long previousMillis = 0; int count = 0; void setup() { // Useful for debugging purposes Serial.begin(9600); while (!Serial) { ; // wait for serial port to connect. Needed for native USB port only } sensors.begin(); } void loop() { unsigned long currentMillis = millis(); if (currentMillis - previousMillis \u003e= interval) { Serial.print(\"Sensor loop #\"); Serial.println(count); // save last time message sent previousMillis = currentMillis; // Get temp(s) sensors.requestTemperatures(); int temp_count = sensors.getDeviceCount(); for (int i = 0; i \u003c temp_count; i++) { Serial.print(\"Reading temp #\"); Serial.print(i); Serial.print(\": \"); Serial.println(sensors.getTempCByIndex(i)); } Serial.println(); count++; } } Running this code, I was getting two readings every minute… oops. No, every 6 seconds. It’s helpful to remember that arduino tracks “time” in milliseconds. My math was off, but it was fine here. I fixed that and moved to the next area. The next area was not connecting to the network. Instead, I distracted myself by tweaking the output.\nJSON I realized that parsing a message with unstructured text would be a pain. I had not done design, remember, but I was getting a tickle in my head where I knew that moment would arrive soon. I substituted some long, solid engineering planning with a spur-of-the-moment design that later would prove to be insufficient.\nNobody wants to write JSON with print statements though. No, you don’t. Stop. There’s a library for that too. I still have more than half my program space left on the board at this point; no worries. Plus, ArduinoJson has a nice example I could borrow from.\nI can just include ArduinoJson.h and ArduinoJson.hpp to create a serializable variable for json. This would be awesome when I got around to adding MQTT. But I didn’t know that yet. I was just going to print it to the console. It just needed a few tweaks to the code.\nFirst, add some const char * variables for the json keys. Doing this statically means that the JSON object can be smaller since the library will link to those instead of trying to store them separately.\nconst char readingKey[] = \"reading_idx\"; const char tempsKey[] = \"temps\"; Next, create the JSON document and populate it. BUT… this is static, so I needed to use a tool (from the same place that created the library) to calculate the size I’d need. This worked well. I did it wrong later, but it worked well. Eventually, I added more strings and some were dynamic. I never updated this value. It will probably have memory issues at some point. Sorry, future-me!\n// Use arduinojson.org/v6/assistant to compute the capacity. StaticJsonDocument\u003c48\u003e doc; doc[nameKey] = name; doc[readingKey] = count; JsonArray data = doc.createNestedArray(tempsKey); int temp_count = sensors.getDeviceCount(); for (int i = 0; i \u003c temp_count; i++) { Serial.print(\"Reading temp #\"); Serial.println(i); data.add(sensors.getTempCByIndex(i)); } serializeJson(doc, Serial); Networking (oops, also everything else) It’s a very good idea to change one thing at a time. I am quite capable of identifying that as a best practice. I am not as skilled when I need to actually follow my own advice. When I added network support. I simultaneously added MQTT as well. I lucked out that none of it is that difficult or complicated. It worked on the third or fourth try. Most issues were with me doing dumb things when I tried to verify communication; not in the actual sensor code itself.\nThe final code (which is running on my sensor right now) is as follows:\n```arduino // ArduinoJson - Version: Latest #include #include // OneWire - Version: Latest #include // DallasTemperature - Version: Latest #include // ArduinoMqttClient - Version: Latest #include #include #include // hardware config #define ONE_WIRE_BUS 2 OneWire oneWire(ONE_WIRE_BUS); DallasTemperature sensors(\u0026oneWire); // Set your MAC address byte mac[] = { 0x90, 0xA2, 0xDA, 0x00, 0x95, 0x0F }; const char name[] = \"90:a2:da:00:95:0f\"; const char nameKey[] = \"name\"; const char readingKey[] = \"reading_idx\"; const char tempsKey[] = \"temps\"; const char broker[] = \"test.mosquitto.org\"; int port = 1883; const char dataTopic[] = \"Hotpants/data\"; // take reading every 60s const long interval = 60000; unsigned long previousMillis = 0; int count = 0; // Ethernet and MQTT related objects EthernetClient ethClient; MqttClient mqttClient(ethClient); void setup() { // Useful for debugging purposes Serial.begin(9600); while (!Serial) { ; // wait for serial port to connect. Needed for native USB port only } // Start the ethernet connection (DHCP) Serial.print(\"Attempting to connect to network\"); while (Ethernet.begin(mac) == 0) { // failed, retry Serial.print(\".\"); delay(3000); } Serial.print(\"You're connected to the network. IP address = \"); Serial.println(Ethernet.localIP()); Serial.println(); // Attempt to connect to the server Serial.print(\"Attempting to connect to MQTT broker: \"); Serial.println(broker); if (mqttClient.connect(broker, port)) { Serial.println(\"Connection established\"); Serial.println(); } else { Serial.print(\"MQTT connection failed. Error code = \"); Serial.println(mqttClient.connectError()); // block if unable to establish connection while (1); } sensors.begin(); } void loop() { // This is needed at the top of the loop! mqttClient.poll(); unsigned long currentMillis = millis(); if (currentMillis - previousMillis \u003e= interval) { // save last time message sent previousMillis = currentMillis; // Get temp(s) sensors.requestTemperatures(); // Use arduinojson.org/v6/assistant to compute the capacity. StaticJsonDocument\u003c48\u003e doc; doc[nameKey] = name; doc[readingKey] = count; JsonArray data = doc.createNestedArray(tempsKey); int temp_count = sensors.getDeviceCount(); for (int i = 0; i \u003c temp_count; i++) { Serial.print(\"Reading temp #\"); Serial.println(i); data.add(sensors.getTempCByIndex(i)); } Serial.print(\"Sending message. Topic = \"); Serial.println(dataTopic); serializeJson(doc, Serial); // send message mqttClient.beginMessage(dataTopic); serializeJson(doc, mqttClient); mqttClient.endMessage(); Serial.println(); count = (count + 1) % 128; } } There are a few issues that I need to address.\nIf the MQTT connection dies. You have to manually restart the sensor. This is not ideal. The mac address, broker, topic, etc. are all hardcoded in the sketch. This is annoying if I want to change anything. I have to disconnect the sensor from the furnace area, bring to my desk, reprogram and take it back. I have some small microSD cards to use and create a config to read in some values, but that’s for a later enhancement. I’m running at about 90% program space used. Adding other functionality may require some optimization. I never send any information about the sensor itself via MQTT. This would be helpful for later use (mac address, sensor type, etc.) The biggest problem… I’m sending the temps in Celcius. Normally fine, but I want to see the HVAC Evaporator temp delta in Fahrenheit. I convert this later, but that’s dumb. I will change this very soon. It’s annoying, but I am taking readings if the furnace is on or off. I don’t really care what the readings are when it’s off. They are meaningless. So I will need to add in a different mechanism to detect if the furnace is turned on and send readings then. I have a few ideas on how to do this but haven’t done any further work than that. Backend Development MQTT Broker I started off by using test.mosquitto.org and realized it works fine for what I’m doing now. I will eventually change this to be hosted locally, but not now. It works well enough for who it’s for (that’s me, btw).\nTimescale I was going to do this locally. I installed postgresql on my linux server. I’m not including what I did for that because I haven’t used it at all. I created a Timescale Cloud account and which is free for 30 days. In a month, I’ll check to see how much that would cost me to avoid maintaining it locally. The setup with their instructions had me up and running within 20 minutes. A+ rating from me so far.\nGrafana Another free trial instance that is sufficient for what I need in a proof-of-concept. I will probably use a local instance here eventually, but it’s working as is for now.\nService Development: The Glue (aka shortshorts) I briefly looked to see if there was a handy service that would take my MQTT data and magically put it into Timescale. No luck. Some things sorta do that. But I haven’t done any projects in Go that have networking, async communication, or contexts. Let’s roll up our sleeves and figure out 50% of the battle GI Joe was talking about.\nAs a brief aside… The name “shortshorts” has very little meaning to this project. I needed a name for the MQTT topic and had chosen “Hotpants” as it seemed funny at 1am when I was developing that part. I didn’t want the topic and this service to be named the same, but I wanted them to share a theme. Nothing further; no hidden meanings.\nMy first pass at a go application to stitch this all together was simplistic. It connected to MQTT and printed the sensor data to the console. There was no lipstick on this pig. I pulled the majority of the code from a couple examples found on GitHub and elsewhere.\nOnce I had that working, I needed to get it into Timescale. Now I must tell you how much I love Timescale for their documentation and examples. I could take almost everything I needed from their Go Tutorial.\nI had everything crammed into main.go and it worked. I didn’t want to share that code with anyone at that point though. Time to make this more like a service, I thought. Hours passed. I ate a Thanksgiving meal and the leftovers. I had a hot mess of packages and channels; partially working, but nothing looked right. Time to use a lifeline and call a friend. One hour with Jack, and it looked really good. There are still warts, but they are self-inflicted and I’m ok with them for now.\nApplication Code Highlights All of the go application code is available on GitHub.\nThe application flow starts in main (this should not be the interesting part of what I’m saying). I set up some contexts to help everything shut down nicely when it’s time, and make all the needed connections before I split off a thread for processing data. That all gets wrapped up with some shutdown logic and we have a decent core to build upon.\nfunc main() { ctx, cancel := context.WithCancel(context.Background()) tsdb, dstream, client := start(ctx) go processLoop(ctx, dstream, tsdb) servicemanager.WaitShutdown(func() { shutdown(cancel, tsdb, client) }) } The processing function loops forever until the context completes. Otherwise, it is reading data from the MQTT data stream channel.\nfunc processLoop(ctx context.Context, ds chan [2]string, tsdb *timescalewrapper.Database) { for { select { case \u003c-ctx.Done(): return case d := \u003c-ds: logger.Info(\"received sensor data\", zap.String(\"topic\", d[0]), zap.String(\"payload\", d[1])) var reading timescalewrapper.SensorData err := json.Unmarshal([]byte(d[1]), \u0026reading) if err != nil { logger.Error(\"unmarshalling payload\", zap.Error(err), zap.String(\"payload\", d[1])) } logger.Debug(\"unmarshalling payload\", zap.Any(\"reading\", reading)) err = tsdb.InsertData(reading) if err != nil { logger.Error(\"inserting data\", zap.Error(err), zap.Any(\"reading\", reading)) } } } } I also ended up using viper to pull configuration from a file. I could have used environmental variables or CLI arguments; I may still end up with either of those. Putting that in a simple YAML document is easy and works well. No more putting sensitive data into my source code. There’s no validation here and it feels like a kludge. It’s a TODO for later.\nfunc readConfig() string { viper.SetConfigName(\"config\") viper.SetConfigType(\"yaml\") viper.AddConfigPath(\".\") err := viper.ReadInConfig() if err != nil { logger.Panic(\"reading config file\", zap.Error(err)) } var sb strings.Builder sb.WriteString(\"postgres://\") sb.WriteString(viper.GetString(\"timescale.user\")) sb.WriteString(\":\") sb.WriteString(viper.GetString(\"timescale.password\")) sb.WriteString(\"@\") sb.WriteString(viper.GetString(\"timescale.host\")) sb.WriteString(\":\") sb.WriteString(viper.GetString(\"timescale.port\")) sb.WriteString(\"/\") sb.WriteString(viper.GetString(\"timescale.database\")) sb.WriteString(\"?sslmode=\") sb.WriteString(viper.GetString(\"timescale.sslmode\")) return sb.String() } In the MQTT package, I set up my connection and create a subscription to the sensor data topic. This is where I populate the channel used elsewhere for data streaming.\nf := func(client mqtt.Client, msg mqtt.Message) { datastream \u003c- [2]string{msg.Topic(), string(msg.Payload())} } if token := cli.Subscribe(topic, byte(qos), f); token.Wait() \u0026\u0026 token.Error() != nil { logger.Error(\"error subscribing to topic\", zap.Error(token.Error())) return nil, token.Error() } Finally, putting the data into the database is fairly straightforward. I have a lot of the structure hardcoded and may want to make this a little more dynamic later to help with reducing the coupling between what I develop on the sensor and how that data gets into Timescale. That’s a low priority item, though, as I don’t expect to see a significant amount of churn here. There are only so many ways to send the readings I’m gathering. I could plan for additional complexity, but that violates at least two of my project criteria. YAGNI indeed.\n// InsertData inserts the data into the database. func (db *Database) InsertData(reading SensorData) error { queryInsertData := `INSERT INTO conditions (time, mac, temp_delta, raw_temp0, raw_temp1) VALUES ($1, $2, $3, $4, $5)` _, err := db.pool.Exec(context.Background(), queryInsertData, time.Now(), reading.Mac, reading.Temps[1]-reading.Temps[0], reading.Temps[0], reading.Temps[1]) if err != nil { return fmt.Errorf(\"inserting data: %w\", err) } return nil } Results Now, Faithful Reader, if you’ve made it this far… what does this actually look like?\n{\"level\":\"info\",\"ts\":\"2022-11-27T20:49:37.475-0500\",\"caller\":\"mqttwrapper/mqtt.go:43\",\"msg\":\"Connected to broker\",\"broker\":\"tcp://test.mosquitto.org:1883\"} {\"level\":\"info\",\"ts\":\"2022-11-27T20:49:37.565-0500\",\"caller\":\"mqttwrapper/mqtt.go:65\",\"msg\":\"successfully subscribed\",\"topic\":\"Hotpants/data\",\"broker\":\"tcp://test.mosquitto.org:1883\"} {\"level\":\"info\",\"ts\":\"2022-11-27T20:56:52.395-0500\",\"caller\":\"shortshorts/main.go:77\",\"msg\":\"received sensor data\",\"topic\":\"Hotpants/data\",\"payload\":\"{\\\"name\\\":\\\"90:a2:da:00:95:0f\\\",\\\"reading_idx\\\":0,\\\"temps\\\":[21.3125,20.6875]}\"} {\"level\":\"info\",\"ts\":\"2022-11-27T20:57:52.409-0500\",\"caller\":\"shortshorts/main.go:77\",\"msg\":\"received sensor data\",\"topic\":\"Hotpants/data\",\"payload\":\"{\\\"name\\\":\\\"90:a2:da:00:95:0f\\\",\\\"reading_idx\\\":1,\\\"temps\\\":[21.25,20.625]}\"} The logging fills up my terminal nicely and gives me an indication that things are working or not. I’ve found that the sensor stops reporting after a day or two. Power cycling brings it back online and I should really look into why that happens. I’m fairly certain it’s a memory issue on the sensor or a failure to recover from a dead MQTT connection.\nThe Grafana dashboard works well and shows me the information I was hoping to see. I believe my temperature probe for the HVAC return is improperly placed and needs to be adjusted. It never really increases when the system is running. It’s likely giving a reading of the basement ambient temp instead of air temps inside the return vent. I’ll tweak it a bit while monitoring the readings to check further. The other possibility is that my system is completely hosed and I need to call the HVAC company for service.\nI wonder what they’d say if I send them this dashboard output as the reason for my service request?\n","wordCount":"3184","inLanguage":"en","datePublished":"2022-11-27T00:00:00Z","dateModified":"2022-11-28T01:44:22-05:00","author":{"@type":"Person","name":"Ben"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://asphaltbuffet.com/posts/2022/11/hvac-monitoring/"},"publisher":{"@type":"Organization","name":"asphaltbuffet dev blog","logo":{"@type":"ImageObject","url":"https://asphaltbuffet.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav aria-label="Site menu" class=nav><div class=logo><a href=https://asphaltbuffet.com/ accesskey=h title="asphalbuffet dev blog (Alt + H)"><img src=https://asphaltbuffet.com/apple-touch-icon.png alt=logo aria-label=logo height=35>asphalbuffet dev blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://asphaltbuffet.com/archive/ title=archive><span>archive</span></a></li><li><a href=https://asphaltbuffet.com/projects/ title=projects><span>projects</span></a></li><li><a href=https://asphaltbuffet.com/tags/ title=tags><span>tags</span></a></li><li><a href=https://asphaltbuffet.com/about title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://asphaltbuffet.com/>Home</a>&nbsp;»&nbsp;<a href=https://asphaltbuffet.com/posts/>Posts</a></div><h1 class=post-title>Monitoring my HVAC</h1><div class=post-meta><span title='2022-11-27 00:00:00 +0000 UTC'>2022-11-27</span>&nbsp;·&nbsp;<span title='2022-11-28 01:44:22 -0500 -0500'>(updated 2022-11-28)</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;3184 words&nbsp;·&nbsp;Ben</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#requirements>Requirements</a></li><li><a href=#choices-choices-choices>Choices, Choices, Choices</a><ul><li><a href=#selecting-the-brains>Selecting the brains</a></li><li><a href=#selecting-the-sensors>Selecting the sensors</a></li><li><a href=#selecting-the-backend-tooling>Selecting the backend tooling</a></li></ul></li><li><a href=#sensor-development>Sensor Development</a><ul><li><a href=#wiring-the-parts-together>Wiring the Parts Together</a></li><li><a href=#sensor-programming>Sensor Programming</a></li><li><a href=#reading-in-temps>Reading in temps</a></li><li><a href=#json>JSON</a></li><li><a href=#networking-oops-also-everything-else>Networking (oops, also everything else)</a></li></ul></li><li><a href=#backend-development>Backend Development</a><ul><li><a href=#mqtt-broker>MQTT Broker</a></li><li><a href=#timescale>Timescale</a></li><li><a href=#grafana>Grafana</a></li></ul></li><li><a href=#service-development-the-glue-aka-shortshorts>Service Development: The Glue (aka shortshorts)</a><ul><li><a href=#application-code-highlights>Application Code Highlights</a></li></ul></li><li><a href=#results>Results</a></li></ul></nav></div></details></div><div class=post-content><p>When I want to know <a href=https://sumzim.com/supply-vs-return-vents>how well my HVAC system is working</a>, smart thermostats and ad-hoc checks don&rsquo;t get me as far as I&rsquo;d like. That means it&rsquo;s time to create an entire system to monitor that information and present it graphically. This is normal, right?</p><figure class=align-center><img loading=lazy src=in-situ.jpg#center></figure><h2 id=requirements>Requirements<a hidden class=anchor aria-hidden=true href=#requirements>#</a></h2><p>Overall, I didn&rsquo;t want to spend much money on this. Yes, time is money, blah blah blah. Learning new tech offsets the cost of time, and it&rsquo;s a better use of late-night chill time than playing a game anyway. Plus, spoilers&mldr; there are graphs. That broad overview gave me the following criteria:</p><ol><li>Don&rsquo;t buy much extra stuff. Keep it less than $20 spending.</li><li>Easy to set up and keep running.</li><li>The initial scale is one sensor. Don&rsquo;t optimize until later, if ever.</li></ol><h2 id=choices-choices-choices>Choices, Choices, Choices<a hidden class=anchor aria-hidden=true href=#choices-choices-choices>#</a></h2><h3 id=selecting-the-brains>Selecting the brains<a hidden class=anchor aria-hidden=true href=#selecting-the-brains>#</a></h3><p>I have a box of microcontrollers in my project area. First, I was going to use a <a href=https://www.beagleboard.org/>BeagleBoard</a> that I got ~10 years ago at the <a href=http://events17.linuxfoundation.org/events/archive/2013/embedded-linux-conference>Embedded Linux Conference</a>. However, I could not find a power adapter for it, so after 20 minutes of searching, I nixed that idea.</p><p>I considered using a <a href=https://www.raspberrypi.org/>raspberry pi</a>, but even though I have a couple spares, I didn&rsquo;t want that level of overkill to get a couple temp readings sent to the cloud.</p><p>Oh, but the handful of <a href=https://docs.arduino.cc/retired/boards/arduino-ethernet-rev3-with-poe>Arduino Ethernet boards that have PoE</a>? Yes, please. It takes care of my need to plug into power (sort of, we&rsquo;ll cover this later). 32k of memory should be fine (yeah, we&rsquo;ll touch on this later too). The temp probes that I have will work fine with this and require minimal breadboard work.</p><h3 id=selecting-the-sensors>Selecting the sensors<a hidden class=anchor aria-hidden=true href=#selecting-the-sensors>#</a></h3><p>This took no time. I needed something I could insert into holes in our ductwork that our HVAC guy cut several months ago. I wanted to use these since it meant that it would get readings from the same place they do for efficiency checks, and I could do less permanent damage to our HVAC system.</p><p>I also had two <a href=https://datasheets.maximintegrated.com/en/ds/DS18B20.pdf>DS18B20</a> sensors laying around from a forgotten project. They are waterproof with long enough cords to work well around the furnace. As a bonus, they use a digital signal so I could use a couple of them on the same input on the arduino without worrying about collisions. This would be really handy later.</p><h3 id=selecting-the-backend-tooling>Selecting the backend tooling<a hidden class=anchor aria-hidden=true href=#selecting-the-backend-tooling>#</a></h3><p>I wanted to use <a href=https://mqtt.org/>MQTT</a> for sensor communication so that I wasn&rsquo;t creating my own protocol. There are a lot of alternatives that I never even considered using. Why? I know people who use MQTT at work. The availability of resources to sanity-check my work meets my goals for #2 really well.</p><p>Database and visualization were chosen via similar criteria. I&rsquo;ve used <a href=https://grafana.com/>Grafana</a> a lot recently to create dashboards, and there&rsquo;s a free cloud version that gets me through proof-of-concept. Same deal with <a href=https://www.timescale.com/>Timescale</a>. The additional benefit of these technologies is that I can spin up instances at home for free later if I want to keep this party going. Or, I can decide to pay for the fully-managed versions in the cloud. This is a problem for future me and I&rsquo;m good for now with what I have.</p><h2 id=sensor-development>Sensor Development<a hidden class=anchor aria-hidden=true href=#sensor-development>#</a></h2><h3 id=wiring-the-parts-together>Wiring the Parts Together<a hidden class=anchor aria-hidden=true href=#wiring-the-parts-together>#</a></h3><figure class=align-center><img loading=lazy src=hotpants-breadboard.png#center></figure><p>The sensor hardware itself was planned to be as plug-and-play as possible. I <a href=https://create.arduino.cc/projecthub/karmette/basic-led-setup-for-beginners-0a124a>added an LED</a> later to see flashy lights. It adds very little value since I am not spending much time in the room where this lives. The LED functionality isn&rsquo;t even in the code I walk through below as it&rsquo;s there as a debug tool more than anything, but I may update that source code later if I decide to leave it in.</p><figure class=align-center><img loading=lazy src=blink.gif#center></figure><h3 id=sensor-programming>Sensor Programming<a hidden class=anchor aria-hidden=true href=#sensor-programming>#</a></h3><p>I started with the sensor ready and no real design. Was this a mistake? Yes. Would I do it the same next time? Also, yes.</p><p>Honestly, the project software is fairly simple so skipping the design meant that now I need to redo a few things to get my data structured better and clean up a few edge cases for failures. It works as is, but it&rsquo;s not pretty. Warts will be highlighted as we go. Grab the popcorn and follow along on the journey!</p><p>Initially, I had planned to set up <a href=https://tinygo.org/>TinyGo</a> and program the boards that way. I have not used TinyGo before. As of this post, I still have not used TinyGo. Arduino provides a <a href=https://create.arduino.cc/editor>web editor</a> for creating sketches and installing them on boards with a minimal tool download. This was easy. See #2 criteria for information on why I went this route.</p><p>I tackled the sensor programming in the following order:</p><ol><li>Get temp readings working</li><li>Get the network connection working</li><li>Get MQTT communication working</li><li>Send temp readings via MQTT</li></ol><h3 id=reading-in-temps>Reading in temps<a hidden class=anchor aria-hidden=true href=#reading-in-temps>#</a></h3><p>Fortunately, there&rsquo;s already an arduino library for the sensors I used. I only needed to include <code>OneWire.h</code> and <code>DallasTemperature.h</code> for the software to function. I found a reference on <a href=https://raspberryautomation.com/connect-multiple-ds18b20-temperature-sensors-to-a-raspberry-pi>wiring up multiple sensors</a> that worked right away. In an hour or so, I had the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-arduino data-lang=arduino><span style=display:flex><span><span style=color:#6272a4>// OneWire - Version: Latest 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;OneWire.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// DallasTemperature - Version: Latest 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;DallasTemperature.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;SPI.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;Ethernet.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// hardware config
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>#define ONE_WIRE_BUS 2
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span>OneWire <span style=color:#50fa7b>oneWire</span>(ONE_WIRE_BUS);
</span></span><span style=display:flex><span>DallasTemperature <span style=color:#50fa7b>sensors</span>(<span style=color:#ff79c6>&amp;</span>oneWire);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// take reading every 60s
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>long</span> interval <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>6000</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> previousMillis <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> count <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setup</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Useful for debugging purposes
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>begin</span>(<span style=color:#bd93f9>9600</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>!</span><span style=color:#50fa7b>Serial</span>) {
</span></span><span style=display:flex><span>    ; <span style=color:#6272a4>// wait for serial port to connect. Needed for native USB port only
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  sensors.<span style=color:#50fa7b>begin</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>loop</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> currentMillis <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>millis</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (currentMillis <span style=color:#ff79c6>-</span> previousMillis <span style=color:#ff79c6>&gt;=</span> interval) {
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;Sensor loop #&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>(count);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// save last time message sent
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    previousMillis <span style=color:#ff79c6>=</span> currentMillis;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Get temp(s)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    sensors.requestTemperatures();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> temp_count <span style=color:#ff79c6>=</span> sensors.getDeviceCount();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> temp_count; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;Reading temp #&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(i);
</span></span><span style=display:flex><span>      <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;: &#34;</span>);      
</span></span><span style=display:flex><span>      <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>(sensors.getTempCByIndex(i));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    count<span style=color:#ff79c6>++</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Running this code, I was getting two readings every minute&mldr; oops. No, every 6 seconds. It&rsquo;s helpful to remember that arduino tracks &ldquo;time&rdquo; in milliseconds. My math was off, but it was fine here. I fixed that and moved to the next area. The next area was not connecting to the network. Instead, I distracted myself by tweaking the output.</p><h3 id=json>JSON<a hidden class=anchor aria-hidden=true href=#json>#</a></h3><p>I realized that parsing a message with unstructured text would be a pain. I had not done design, remember, but I was getting a tickle in my head where I knew that moment would arrive soon. I substituted some long, solid engineering planning with a spur-of-the-moment design that later would prove to be insufficient.</p><p>Nobody wants to write JSON with print statements though. No, you don&rsquo;t. Stop. There&rsquo;s a library for that too. I still have more than half my program space left on the board at this point; no worries. Plus, ArduinoJson has a nice <a href=https://arduinojson.org/v6/example/generator/>example</a> I could borrow from.</p><p>I can just include <code>ArduinoJson.h</code> and <code>ArduinoJson.hpp</code> to create a serializable variable for json. This would be awesome when I got around to adding MQTT. But I didn&rsquo;t know that yet. I was just going to print it to the console. It just needed a few tweaks to the code.</p><p>First, add some <code>const char *</code> variables for the json keys. Doing this statically means that the JSON object can be smaller since the library will link to those instead of trying to store them separately.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-arduino data-lang=arduino><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> readingKey[] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;reading_idx&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> tempsKey[] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;temps&#34;</span>;
</span></span></code></pre></div><p>Next, create the JSON document and populate it. BUT&mldr; this is static, so I needed to use a <a href=https://arduinojson.org/v6/assistant>tool</a> (from the same place that created the library) to calculate the size I&rsquo;d need. This worked well. I did it wrong later, but it worked well. Eventually, I added more strings and some were dynamic. I never updated this value. It will probably have memory issues at some point. Sorry, future-me!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-arduino data-lang=arduino><span style=display:flex><span><span style=color:#6272a4>// Use arduinojson.org/v6/assistant to compute the capacity.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>StaticJsonDocument<span style=color:#ff79c6>&lt;</span><span style=color:#bd93f9>48</span><span style=color:#ff79c6>&gt;</span> doc;
</span></span><span style=display:flex><span>doc[nameKey] <span style=color:#ff79c6>=</span> name;
</span></span><span style=display:flex><span>doc[readingKey] <span style=color:#ff79c6>=</span> count;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>JsonArray data <span style=color:#ff79c6>=</span> doc.createNestedArray(tempsKey);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> temp_count <span style=color:#ff79c6>=</span> sensors.getDeviceCount();
</span></span><span style=display:flex><span><span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> temp_count; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;Reading temp #&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>(i);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  data.add(sensors.getTempCByIndex(i));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>serializeJson(doc, <span style=color:#50fa7b>Serial</span>);
</span></span></code></pre></div><h3 id=networking-oops-also-everything-else>Networking (oops, also everything else)<a hidden class=anchor aria-hidden=true href=#networking-oops-also-everything-else>#</a></h3><p>It&rsquo;s a very good idea to change one thing at a time. I am quite capable of identifying that as a best practice. I am not as skilled when I need to actually follow my own advice. When I added network support. I simultaneously added MQTT as well. I lucked out that none of it is that difficult or complicated. It worked on the third or fourth try. Most issues were with me doing dumb things when I tried to verify communication; not in the actual sensor code itself.</p><p>The final code (which is running on my sensor right now) is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-arduino data-lang=arduino><span style=display:flex><span>```arduino
</span></span><span style=display:flex><span><span style=color:#6272a4>// ArduinoJson - Version: Latest 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;ArduinoJson.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;ArduinoJson.hpp&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// OneWire - Version: Latest 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;OneWire.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// DallasTemperature - Version: Latest 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;DallasTemperature.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// ArduinoMqttClient - Version: Latest
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;ArduinoMqttClient.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;SPI.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;Ethernet.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// hardware config
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>#define ONE_WIRE_BUS 2
</span></span></span><span style=display:flex><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span>OneWire oneWire(ONE_WIRE_BUS);
</span></span><span style=display:flex><span>DallasTemperature <span style=color:#50fa7b>sensors</span>(<span style=color:#ff79c6>&amp;</span>oneWire);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Set your MAC address
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd>byte</span> mac[] <span style=color:#ff79c6>=</span> { <span style=color:#bd93f9>0x90</span>, <span style=color:#bd93f9>0xA2</span>, <span style=color:#bd93f9>0xDA</span>, <span style=color:#bd93f9>0x00</span>, <span style=color:#bd93f9>0x95</span>, <span style=color:#bd93f9>0x0F</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> name[] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;90:a2:da:00:95:0f&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> nameKey[] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;name&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> readingKey[] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;reading_idx&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> tempsKey[] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;temps&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> broker[] <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;test.mosquitto.org&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span>        port     <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1883</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> dataTopic[]  <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;Hotpants/data&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// take reading every 60s
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>long</span> interval <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>60000</span>;
</span></span><span style=display:flex><span><span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> previousMillis <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>int</span> count <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Ethernet and MQTT related objects
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#50fa7b>EthernetClient</span> ethClient;
</span></span><span style=display:flex><span>MqttClient <span style=color:#50fa7b>mqttClient</span>(ethClient);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setup</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Useful for debugging purposes
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>begin</span>(<span style=color:#bd93f9>9600</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>!</span><span style=color:#50fa7b>Serial</span>) {
</span></span><span style=display:flex><span>    ; <span style=color:#6272a4>// wait for serial port to connect. Needed for native USB port only
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Start the ethernet connection (DHCP)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;Attempting to connect to network&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>while</span> (<span style=color:#50fa7b>Ethernet</span>.<span style=color:#50fa7b>begin</span>(mac) <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// failed, retry
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;.&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>delay</span>(<span style=color:#bd93f9>3000</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;You&#39;re connected to the network. IP address = &#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>(<span style=color:#50fa7b>Ethernet</span>.<span style=color:#50fa7b>localIP</span>());
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// Attempt to connect to the server
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;Attempting to connect to MQTT broker: &#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>(broker);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (mqttClient.<span style=color:#50fa7b>connect</span>(broker, port))
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>(<span style=color:#f1fa8c>&#34;Connection established&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;MQTT connection failed. Error code = &#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>(mqttClient.connectError());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// block if unable to establish connection
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>while</span> (<span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  sensors.<span style=color:#50fa7b>begin</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>loop</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#6272a4>// This is needed at the top of the loop!
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  mqttClient.poll();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd>unsigned</span> <span style=color:#8be9fd>long</span> currentMillis <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>millis</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> (currentMillis <span style=color:#ff79c6>-</span> previousMillis <span style=color:#ff79c6>&gt;=</span> interval) {
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// save last time message sent
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    previousMillis <span style=color:#ff79c6>=</span> currentMillis;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Get temp(s)
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    sensors.requestTemperatures();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Use arduinojson.org/v6/assistant to compute the capacity.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    StaticJsonDocument<span style=color:#ff79c6>&lt;</span><span style=color:#bd93f9>48</span><span style=color:#ff79c6>&gt;</span> doc;
</span></span><span style=display:flex><span>    doc[nameKey] <span style=color:#ff79c6>=</span> name;
</span></span><span style=display:flex><span>    doc[readingKey] <span style=color:#ff79c6>=</span> count;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    JsonArray data <span style=color:#ff79c6>=</span> doc.createNestedArray(tempsKey);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> temp_count <span style=color:#ff79c6>=</span> sensors.getDeviceCount();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> temp_count; i<span style=color:#ff79c6>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;Reading temp #&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>(i);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      data.add(sensors.getTempCByIndex(i));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>print</span>(<span style=color:#f1fa8c>&#34;Sending message. Topic = &#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>(dataTopic);
</span></span><span style=display:flex><span>    serializeJson(doc, <span style=color:#50fa7b>Serial</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// send message
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    mqttClient.beginMessage(dataTopic);
</span></span><span style=display:flex><span>    serializeJson(doc, mqttClient);
</span></span><span style=display:flex><span>    mqttClient.endMessage();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#50fa7b>Serial</span>.<span style=color:#50fa7b>println</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    count <span style=color:#ff79c6>=</span> (count <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>%</span> <span style=color:#bd93f9>128</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>There are a few issues that I need to address.</p><ul><li>If the MQTT connection dies. You have to manually restart the sensor. This is not ideal.</li><li>The mac address, broker, topic, etc. are all hardcoded in the sketch. This is annoying if I want to change anything. I have to disconnect the sensor from the furnace area, bring to my desk, reprogram and take it back. I have some small microSD cards to use and create a config to read in some values, but that&rsquo;s for a later enhancement.</li><li>I&rsquo;m running at about 90% program space used. Adding other functionality may require some optimization.</li><li>I never send any information about the sensor itself via MQTT. This would be helpful for later use (mac address, sensor type, etc.)</li><li>The biggest problem&mldr; I&rsquo;m sending the temps in Celcius. Normally fine, but I want to see the HVAC Evaporator temp delta in Fahrenheit. I convert this later, but that&rsquo;s dumb. I will change this very soon.</li><li>It&rsquo;s annoying, but I am taking readings if the furnace is on or off. I don&rsquo;t really care what the readings are when it&rsquo;s off. They are meaningless. So I will need to add in a different mechanism to detect if the furnace is turned on and send readings then. I have a <a href=https://www.pes-psrc.org/kb/published/reports/Use%20of%20Hall%20Effect%20Sensors%20for%20Protection%20and%20Monitoring%20Applications%20-%20March%202018.pdf>few ideas</a> on how to do this but haven&rsquo;t done any further work than that.</li></ul><h2 id=backend-development>Backend Development<a hidden class=anchor aria-hidden=true href=#backend-development>#</a></h2><h3 id=mqtt-broker>MQTT Broker<a hidden class=anchor aria-hidden=true href=#mqtt-broker>#</a></h3><p>I started off by using <code>test.mosquitto.org</code> and realized it works fine for what I&rsquo;m doing now. I will eventually change this to be hosted locally, but not now. It works well enough for who it&rsquo;s for (that&rsquo;s me, btw).</p><h3 id=timescale>Timescale<a hidden class=anchor aria-hidden=true href=#timescale>#</a></h3><p>I was going to do this locally. I installed postgresql on my linux server. I&rsquo;m not including what I did for that because I haven&rsquo;t used it at all. I created a Timescale Cloud account and which is free for 30 days. In a month, I&rsquo;ll check to see how much that would cost me to avoid maintaining it locally. The setup with their instructions had me up and running within 20 minutes. A+ rating from me so far.</p><h3 id=grafana>Grafana<a hidden class=anchor aria-hidden=true href=#grafana>#</a></h3><p>Another free trial instance that is sufficient for what I need in a proof-of-concept. I will probably use a local instance here eventually, but it&rsquo;s working as is for now.</p><h2 id=service-development-the-glue-aka-shortshorts>Service Development: The Glue (aka shortshorts)<a hidden class=anchor aria-hidden=true href=#service-development-the-glue-aka-shortshorts>#</a></h2><p>I briefly looked to see if there was a handy service that would take my MQTT data and magically put it into Timescale. No luck. Some things <strong>sorta</strong> do that. But I haven&rsquo;t done any projects in Go that have networking, async communication, or contexts. Let&rsquo;s roll up our sleeves and figure out 50% of the battle GI Joe was talking about.</p><p>As a brief aside&mldr; The name &ldquo;shortshorts&rdquo; has very little meaning to this project. I needed a name for the MQTT topic and had chosen &ldquo;Hotpants&rdquo; as it seemed funny at 1am when I was developing that part. I didn&rsquo;t want the topic and this service to be named the same, but I wanted them to share a theme. Nothing further; no hidden meanings.</p><p>My first pass at a go application to stitch this all together was simplistic. It connected to MQTT and printed the sensor data to the console. There was no lipstick on this pig. I pulled the majority of the code from a couple examples found on <a href=https://github.com/CloudMQTT/go-mqtt-example/blob/22e6befea8ed6005090dfdce063aa7bd93e2279b/main.go>GitHub</a> and <a href=https://levelup.gitconnected.com/how-to-use-mqtt-with-go-89c617915774>elsewhere</a>.</p><p>Once I had that working, I needed to get it into Timescale. Now I must tell you how much I love Timescale for their documentation and examples. I could take almost everything I needed from their <a href=https://docs.timescale.com/timescaledb/latest/quick-start/golang/>Go Tutorial</a>.</p><p>I had everything crammed into <code>main.go</code> and it worked. I didn&rsquo;t want to share that code with anyone at that point though. Time to <a href=https://github.com/gbeletti/service-golang>make this more like a service</a>, I thought. Hours passed. I ate a Thanksgiving meal and the leftovers. I had a hot mess of packages and channels; partially working, but nothing looked right. Time to use a lifeline and call a friend. One hour with Jack, and it looked really good. There are still warts, but they are self-inflicted and I&rsquo;m ok with them for now.</p><h3 id=application-code-highlights>Application Code Highlights<a hidden class=anchor aria-hidden=true href=#application-code-highlights>#</a></h3><p>All of the go application code is <a href=https://github.com/asphaltbuffet/shortshorts>available on GitHub</a>.</p><p>The application flow starts in main (this should not be the interesting part of what I&rsquo;m saying). I set up some contexts to help everything shut down nicely when it&rsquo;s time, and make all the needed connections before I split off a thread for processing data. That all gets wrapped up with some shutdown logic and we have a decent core to build upon.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>main</span>() {
</span></span><span style=display:flex><span>  ctx, cancel <span style=color:#ff79c6>:=</span> context.<span style=color:#50fa7b>WithCancel</span>(context.<span style=color:#50fa7b>Background</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  tsdb, dstream, client <span style=color:#ff79c6>:=</span> <span style=color:#50fa7b>start</span>(ctx)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>go</span> <span style=color:#50fa7b>processLoop</span>(ctx, dstream, tsdb)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  servicemanager.<span style=color:#50fa7b>WaitShutdown</span>(<span style=color:#8be9fd;font-style:italic>func</span>() { <span style=color:#50fa7b>shutdown</span>(cancel, tsdb, client) })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The processing function loops forever until the context completes. Otherwise, it is reading data from the MQTT data stream channel.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>processLoop</span>(ctx context.Context, ds <span style=color:#8be9fd;font-style:italic>chan</span> [<span style=color:#bd93f9>2</span>]<span style=color:#8be9fd>string</span>, tsdb <span style=color:#ff79c6>*</span>timescalewrapper.Database) {
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> <span style=color:#ff79c6>&lt;-</span>ctx.<span style=color:#50fa7b>Done</span>():
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> d <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>&lt;-</span>ds:
</span></span><span style=display:flex><span>      logger.<span style=color:#50fa7b>Info</span>(<span style=color:#f1fa8c>&#34;received sensor data&#34;</span>, zap.<span style=color:#50fa7b>String</span>(<span style=color:#f1fa8c>&#34;topic&#34;</span>, d[<span style=color:#bd93f9>0</span>]), zap.<span style=color:#50fa7b>String</span>(<span style=color:#f1fa8c>&#34;payload&#34;</span>, d[<span style=color:#bd93f9>1</span>]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>var</span> reading timescalewrapper.SensorData
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      err <span style=color:#ff79c6>:=</span> json.<span style=color:#50fa7b>Unmarshal</span>([]<span style=color:#8be9fd;font-style:italic>byte</span>(d[<span style=color:#bd93f9>1</span>]), <span style=color:#ff79c6>&amp;</span>reading)
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>Error</span>(<span style=color:#f1fa8c>&#34;unmarshalling payload&#34;</span>, zap.<span style=color:#50fa7b>Error</span>(err), zap.<span style=color:#50fa7b>String</span>(<span style=color:#f1fa8c>&#34;payload&#34;</span>, d[<span style=color:#bd93f9>1</span>]))
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      logger.<span style=color:#50fa7b>Debug</span>(<span style=color:#f1fa8c>&#34;unmarshalling payload&#34;</span>, zap.<span style=color:#50fa7b>Any</span>(<span style=color:#f1fa8c>&#34;reading&#34;</span>, reading))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      err = tsdb.<span style=color:#50fa7b>InsertData</span>(reading)
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>        logger.<span style=color:#50fa7b>Error</span>(<span style=color:#f1fa8c>&#34;inserting data&#34;</span>, zap.<span style=color:#50fa7b>Error</span>(err), zap.<span style=color:#50fa7b>Any</span>(<span style=color:#f1fa8c>&#34;reading&#34;</span>, reading))
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I also ended up using viper to pull configuration from a file. I could have used environmental variables or CLI arguments; I may still end up with either of those. Putting that in a simple YAML document is easy and works well. No more putting sensitive data into my source code. There&rsquo;s no validation here and it feels like a kludge. It&rsquo;s a TODO for later.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>func</span> <span style=color:#50fa7b>readConfig</span>() <span style=color:#8be9fd>string</span> {
</span></span><span style=display:flex><span>  viper.<span style=color:#50fa7b>SetConfigName</span>(<span style=color:#f1fa8c>&#34;config&#34;</span>)
</span></span><span style=display:flex><span>  viper.<span style=color:#50fa7b>SetConfigType</span>(<span style=color:#f1fa8c>&#34;yaml&#34;</span>)
</span></span><span style=display:flex><span>  viper.<span style=color:#50fa7b>AddConfigPath</span>(<span style=color:#f1fa8c>&#34;.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  err <span style=color:#ff79c6>:=</span> viper.<span style=color:#50fa7b>ReadInConfig</span>()
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>    logger.<span style=color:#50fa7b>Panic</span>(<span style=color:#f1fa8c>&#34;reading config file&#34;</span>, zap.<span style=color:#50fa7b>Error</span>(err))
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#8be9fd;font-style:italic>var</span> sb strings.Builder
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(<span style=color:#f1fa8c>&#34;postgres://&#34;</span>)
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(viper.<span style=color:#50fa7b>GetString</span>(<span style=color:#f1fa8c>&#34;timescale.user&#34;</span>))
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(<span style=color:#f1fa8c>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(viper.<span style=color:#50fa7b>GetString</span>(<span style=color:#f1fa8c>&#34;timescale.password&#34;</span>))
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(<span style=color:#f1fa8c>&#34;@&#34;</span>)
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(viper.<span style=color:#50fa7b>GetString</span>(<span style=color:#f1fa8c>&#34;timescale.host&#34;</span>))
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(<span style=color:#f1fa8c>&#34;:&#34;</span>)
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(viper.<span style=color:#50fa7b>GetString</span>(<span style=color:#f1fa8c>&#34;timescale.port&#34;</span>))
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(<span style=color:#f1fa8c>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(viper.<span style=color:#50fa7b>GetString</span>(<span style=color:#f1fa8c>&#34;timescale.database&#34;</span>))
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(<span style=color:#f1fa8c>&#34;?sslmode=&#34;</span>)
</span></span><span style=display:flex><span>  sb.<span style=color:#50fa7b>WriteString</span>(viper.<span style=color:#50fa7b>GetString</span>(<span style=color:#f1fa8c>&#34;timescale.sslmode&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> sb.<span style=color:#50fa7b>String</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In the MQTT package, I set up my connection and create a subscription to the sensor data topic. This is where I populate the channel used elsewhere for data streaming.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span>f <span style=color:#ff79c6>:=</span> <span style=color:#8be9fd;font-style:italic>func</span>(client mqtt.Client, msg mqtt.Message) {
</span></span><span style=display:flex><span>  datastream <span style=color:#ff79c6>&lt;-</span> [<span style=color:#bd93f9>2</span>]<span style=color:#8be9fd>string</span>{msg.<span style=color:#50fa7b>Topic</span>(), <span style=color:#8be9fd;font-style:italic>string</span>(msg.<span style=color:#50fa7b>Payload</span>())}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> token <span style=color:#ff79c6>:=</span> cli.<span style=color:#50fa7b>Subscribe</span>(topic, <span style=color:#8be9fd;font-style:italic>byte</span>(qos), f); token.<span style=color:#50fa7b>Wait</span>() <span style=color:#ff79c6>&amp;&amp;</span> token.<span style=color:#50fa7b>Error</span>() <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>  logger.<span style=color:#50fa7b>Error</span>(<span style=color:#f1fa8c>&#34;error subscribing to topic&#34;</span>, zap.<span style=color:#50fa7b>Error</span>(token.<span style=color:#50fa7b>Error</span>()))
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>, token.<span style=color:#50fa7b>Error</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally, putting the data into the database is fairly straightforward. I have a lot of the structure hardcoded and may want to make this a little more dynamic later to help with reducing the coupling between what I develop on the sensor and how that data gets into Timescale. That&rsquo;s a low priority item, though, as I don&rsquo;t expect to see a significant amount of churn here. There are only so many ways to send the readings I&rsquo;m gathering. I could plan for additional complexity, but that violates at least two of my project criteria. YAGNI indeed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#6272a4>// InsertData inserts the data into the database.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (db <span style=color:#ff79c6>*</span>Database) <span style=color:#50fa7b>InsertData</span>(reading SensorData) <span style=color:#8be9fd>error</span> {
</span></span><span style=display:flex><span>  queryInsertData <span style=color:#ff79c6>:=</span> <span style=color:#f1fa8c>`INSERT INTO conditions (time, mac, temp_delta, raw_temp0, raw_temp1) VALUES ($1, $2, $3, $4, $5)`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  _, err <span style=color:#ff79c6>:=</span> db.pool.<span style=color:#50fa7b>Exec</span>(context.<span style=color:#50fa7b>Background</span>(), queryInsertData, time.<span style=color:#50fa7b>Now</span>(), reading.Mac, reading.Temps[<span style=color:#bd93f9>1</span>]<span style=color:#ff79c6>-</span>reading.Temps[<span style=color:#bd93f9>0</span>], reading.Temps[<span style=color:#bd93f9>0</span>], reading.Temps[<span style=color:#bd93f9>1</span>])
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> fmt.<span style=color:#50fa7b>Errorf</span>(<span style=color:#f1fa8c>&#34;inserting data: %w&#34;</span>, err)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=results>Results<a hidden class=anchor aria-hidden=true href=#results>#</a></h2><p>Now, Faithful Reader, if you&rsquo;ve made it this far&mldr; what does this actually look like?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#ff79c6>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#ff79c6>&#34;ts&#34;</span>:<span style=color:#f1fa8c>&#34;2022-11-27T20:49:37.475-0500&#34;</span>,<span style=color:#ff79c6>&#34;caller&#34;</span>:<span style=color:#f1fa8c>&#34;mqttwrapper/mqtt.go:43&#34;</span>,<span style=color:#ff79c6>&#34;msg&#34;</span>:<span style=color:#f1fa8c>&#34;Connected to broker&#34;</span>,<span style=color:#ff79c6>&#34;broker&#34;</span>:<span style=color:#f1fa8c>&#34;tcp://test.mosquitto.org:1883&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#ff79c6>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#ff79c6>&#34;ts&#34;</span>:<span style=color:#f1fa8c>&#34;2022-11-27T20:49:37.565-0500&#34;</span>,<span style=color:#ff79c6>&#34;caller&#34;</span>:<span style=color:#f1fa8c>&#34;mqttwrapper/mqtt.go:65&#34;</span>,<span style=color:#ff79c6>&#34;msg&#34;</span>:<span style=color:#f1fa8c>&#34;successfully subscribed&#34;</span>,<span style=color:#ff79c6>&#34;topic&#34;</span>:<span style=color:#f1fa8c>&#34;Hotpants/data&#34;</span>,<span style=color:#ff79c6>&#34;broker&#34;</span>:<span style=color:#f1fa8c>&#34;tcp://test.mosquitto.org:1883&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#ff79c6>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#ff79c6>&#34;ts&#34;</span>:<span style=color:#f1fa8c>&#34;2022-11-27T20:56:52.395-0500&#34;</span>,<span style=color:#ff79c6>&#34;caller&#34;</span>:<span style=color:#f1fa8c>&#34;shortshorts/main.go:77&#34;</span>,<span style=color:#ff79c6>&#34;msg&#34;</span>:<span style=color:#f1fa8c>&#34;received sensor data&#34;</span>,<span style=color:#ff79c6>&#34;topic&#34;</span>:<span style=color:#f1fa8c>&#34;Hotpants/data&#34;</span>,<span style=color:#ff79c6>&#34;payload&#34;</span>:<span style=color:#f1fa8c>&#34;{\&#34;name\&#34;:\&#34;90:a2:da:00:95:0f\&#34;,\&#34;reading_idx\&#34;:0,\&#34;temps\&#34;:[21.3125,20.6875]}&#34;</span>}
</span></span><span style=display:flex><span>{<span style=color:#ff79c6>&#34;level&#34;</span>:<span style=color:#f1fa8c>&#34;info&#34;</span>,<span style=color:#ff79c6>&#34;ts&#34;</span>:<span style=color:#f1fa8c>&#34;2022-11-27T20:57:52.409-0500&#34;</span>,<span style=color:#ff79c6>&#34;caller&#34;</span>:<span style=color:#f1fa8c>&#34;shortshorts/main.go:77&#34;</span>,<span style=color:#ff79c6>&#34;msg&#34;</span>:<span style=color:#f1fa8c>&#34;received sensor data&#34;</span>,<span style=color:#ff79c6>&#34;topic&#34;</span>:<span style=color:#f1fa8c>&#34;Hotpants/data&#34;</span>,<span style=color:#ff79c6>&#34;payload&#34;</span>:<span style=color:#f1fa8c>&#34;{\&#34;name\&#34;:\&#34;90:a2:da:00:95:0f\&#34;,\&#34;reading_idx\&#34;:1,\&#34;temps\&#34;:[21.25,20.625]}&#34;</span>}
</span></span></code></pre></div><p>The logging fills up my terminal nicely and gives me an indication that things are working or not. I&rsquo;ve found that the sensor stops reporting after a day or two. Power cycling brings it back online and I should really look into why that happens. I&rsquo;m fairly certain it&rsquo;s a memory issue on the sensor or a failure to recover from a dead MQTT connection.</p><figure class=align-center><img loading=lazy src=grafana.png#center></figure><p>The Grafana dashboard works well and shows me the information I was hoping to see. I believe my temperature probe for the HVAC return is improperly placed and needs to be adjusted. It never really increases when the system is running. It&rsquo;s likely giving a reading of the basement ambient temp instead of air temps inside the return vent. I&rsquo;ll tweak it a bit while monitoring the readings to check further. The other possibility is that my system is completely hosed and I need to call the HVAC company for service.</p><p>I wonder what they&rsquo;d say if I send them this dashboard output as the reason for my service request?</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://asphaltbuffet.com/tags/arduino/>arduino</a></li><li><a href=https://asphaltbuffet.com/tags/go/>go</a></li><li><a href=https://asphaltbuffet.com/tags/grafana/>grafana</a></li><li><a href=https://asphaltbuffet.com/tags/timescale/>timescale</a></li><li><a href=https://asphaltbuffet.com/tags/async/>async</a></li><li><a href=https://asphaltbuffet.com/tags/monitoring/>monitoring</a></li><li><a href=https://asphaltbuffet.com/tags/sensors/>sensors</a></li></ul><nav aria-label="Related Pages" class=paginav><a class=next href=https://asphaltbuffet.com/posts/2022/07/js-integrity/><span class=title>Next »</span><br><span>SRI: Fixing Security Warnings</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Monitoring my HVAC on twitter" href="https://twitter.com/intent/tweet/?text=Monitoring%20my%20HVAC&amp;url=https%3a%2f%2fasphaltbuffet.com%2fposts%2f2022%2f11%2fhvac-monitoring%2f&amp;hashtags=arduino%2cgo%2cgrafana%2ctimescale%2casync%2cmonitoring%2csensors"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Monitoring my HVAC on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fasphaltbuffet.com%2fposts%2f2022%2f11%2fhvac-monitoring%2f&amp;title=Monitoring%20my%20HVAC&amp;summary=Monitoring%20my%20HVAC&amp;source=https%3a%2f%2fasphaltbuffet.com%2fposts%2f2022%2f11%2fhvac-monitoring%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Monitoring my HVAC on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fasphaltbuffet.com%2fposts%2f2022%2f11%2fhvac-monitoring%2f&title=Monitoring%20my%20HVAC"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Monitoring my HVAC on telegram" href="https://telegram.me/share/url?text=Monitoring%20my%20HVAC&amp;url=https%3a%2f%2fasphaltbuffet.com%2fposts%2f2022%2f11%2fhvac-monitoring%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://asphaltbuffet.com/>asphaltbuffet dev blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>